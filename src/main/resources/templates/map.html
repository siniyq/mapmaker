<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–•–∏—Ç–º–∞–ø–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/js/heatmap.js?v=1.2" defer></script>
    <script src="/js/thematic-route.js" defer></script>
    <script src="/js/cultural-route.js" defer></script>
    <script src="/js/personalization.js" defer></script>
    <script src="/js/auth.js" defer></script>
</head>
<body>
    <div id="control-panel">
        <div class="theme-switcher">
            <button id="theme-toggle" class="neo-button" style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px; width: 100%;">
                <span id="theme-icon">üåô</span>
                <span id="theme-text" style="margin-left: 8px;">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
            </button>
        </div>

        <h3>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <div id="profile-container">
            <div id="auth-container">
                <button id="login-button" class="neo-button" onclick="window.location.href='/login'">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <p style="font-size: 0.85em; margin-top: 5px; color: #666; text-align: center;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç—ã –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
            </div>
            <div id="user-profile" style="display: none;">
                <p class="user-greeting">–ü—Ä–∏–≤–µ—Ç, <span id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>!</p>
                <div class="profile-buttons">
                    <button id="saved-routes" class="neo-button">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã</button>
                    <button id="logout-btn" onclick="logout();" class="neo-button danger">–í—ã—Ö–æ–¥</button>
                </div>
            </div>
            
            <script>
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã"
                document.getElementById('saved-routes').addEventListener('click', function() {
                    if (window.personalizationModule) {
                        window.personalizationModule.showSavedRoutes();
                    } else {
                        NeoDialog.alert('–û—à–∏–±–∫–∞', '–ú–æ–¥—É–ª—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    }
                });
                
                function logout() {
                    console.log('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã...');
                    
                    // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
                    localStorage.removeItem('userData');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π
                    const authContainer = document.getElementById('auth-container');
                    const userProfile = document.getElementById('user-profile');
                    
                    if (authContainer) {
                        authContainer.style.display = 'block';
                        console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–∫–∞–∑–∞–Ω');
                    } else {
                        console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                    
                    if (userProfile) {
                        userProfile.style.display = 'none';
                        console.log('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–∫—Ä—ã—Ç');
                    } else {
                        console.log('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –º–æ–¥—É–ª–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
                    if (window.personalizationModule) {
                        window.personalizationModule.isAuthenticated = false;
                        window.personalizationModule.userProfile = null;
                        console.log('–ú–æ–¥—É–ª—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    NeoDialog.alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', '–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
                    // window.location.reload();
                    
                    // –ü–æ –∂–µ–ª–∞–Ω–∏—é - –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
                    fetch('/api/users/logout', { method: 'POST' })
                        .then(response => console.log('–°–µ—Ä–≤–µ—Ä–Ω–∞—è —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'))
                        .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã:', error));
                }
            </script>
        </div>

        <h3>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
        <p class="neo-note">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –ê, –∑–∞—Ç–µ–º —Ç–æ—á–∫—É –ë.</p>
        
        <h3>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h3>
        <div id="profile-buttons">
            <button id="profile-foot" class="neo-button active">–ü–µ—à–∫–æ–º</button>
            <button id="profile-bike" class="neo-button">–í–µ–ª–æ—Å–∏–ø–µ–¥</button>
            <button id="profile-car" class="neo-button">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</button>
        </div>
            
        <button id="reset-button" class="neo-button">–°–±—Ä–æ—Å–∏—Ç—å —Ç–æ—á–∫–∏</button>
        
        <h3>–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç</h3>
        <p class="neo-note">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞:</p>
        
        <!-- –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–π POI -->
        <div class="neo-tabs-container">
            <div class="neo-tabs">
                <button id="category-food" class="neo-tab active">–ï–¥–∞</button>
                <button id="category-cultural" class="neo-tab">–ö—É–ª—å—Ç—É—Ä–∞</button>
            </div>
        </div>
        
        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ï–¥–∞ -->
        <div id="poi-food-buttons" class="poi-category active">
            <div class="poi-buttons-grid">
                <button id="poi-restaurant" class="neo-button">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</button>
                <button id="poi-cafe" class="neo-button">–ö–∞—Ñ–µ</button>
                <button id="poi-bar" class="neo-button">–ë–∞—Ä—ã</button>
            </div>
        </div>
        
        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ö—É–ª—å—Ç—É—Ä–∞ -->
        <div id="poi-cultural-buttons" class="poi-category">
            <!-- –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∏ —Å–µ—Ç–∫—É -->
            
            <!-- –ë–ª–æ–∫ –ö—É–ª—å—Ç—É—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç -->
            <div class="cultural-route-block">
                <p class="neo-note">–ú–∞—Ä—à—Ä—É—Ç –ø–æ –∫—É–ª—å—Ç—É—Ä–Ω—ã–º –º–µ—Å—Ç–∞–º –í–∏—Ç–µ–±—Å–∫–∞</p>
                
                <div class="neo-options-group">
                    <div class="neo-checkbox-group">
                        <input type="checkbox" id="include-museum" checked>
                        <label for="include-museum">–í–∫–ª—é—á–∏—Ç—å –º—É–∑–µ–π</label>
                    </div>
                    <div class="neo-checkbox-group">
                        <input type="checkbox" id="include-park" checked>
                        <label for="include-park">–í–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–∫</label>
                    </div>
                    
                    <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∏–ø—ã –º–µ—Å—Ç:</label>
                    <div class="neo-checkbox-list">
                        <div class="neo-checkbox-group">
                            <input type="checkbox" id="include-theater" class="cultural-type-checkbox" value="theater" checked>
                            <label for="include-theater">–¢–µ–∞—Ç—Ä—ã</label>
                        </div>
                        <div class="neo-checkbox-group">
                            <input type="checkbox" id="include-church" class="cultural-type-checkbox" value="church" checked>
                            <label for="include-church">–¶–µ—Ä–∫–≤–∏/–°–æ–±–æ—Ä—ã</label>
                        </div>
                        <div class="neo-checkbox-group">
                            <input type="checkbox" id="include-art-gallery" class="cultural-type-checkbox" value="art_gallery" checked>
                            <label for="include-art-gallery">–ì–∞–ª–µ—Ä–µ–∏</label>
                        </div>
                        <div class="neo-checkbox-group">
                            <input type="checkbox" id="include-library" class="cultural-type-checkbox" value="library" checked>
                            <label for="include-library">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏</label>
                        </div>
                        <div class="neo-checkbox-group">
                            <input type="checkbox" id="include-attraction" class="cultural-type-checkbox" value="tourist_attraction" checked>
                            <label for="include-attraction">–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</label>
                        </div>
                    </div>
                </div>
                
                <div class="neo-slider">
                    <label for="cultural-poi-count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ (3-7):</label>
                    <div class="slider-container">
                        <input type="range" id="cultural-poi-count" min="3" max="7" value="4">
                        <span id="cultural-poi-count-value">4</span>
                    </div>
                </div>
                
                <button id="cultural-route-button" class="neo-button">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∫—É–ª—å—Ç—É—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç</button>
            </div>
        </div>
        
        <button id="thematic-route-button" class="neo-button">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç</button>
        <button id="shuffle-poi-button" class="neo-button">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ç–æ—á–∫–∏</button>
        <button id="optimize-route-button" class="neo-button">–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>

        <div class="neo-slider">
            <label for="poi-count-slider">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ (3-10):</label>
            <div class="slider-container">
                <input type="range" id="poi-count-slider" min="3" max="10" value="5">
                <span id="poi-count-value">5</span>
            </div>
            <p class="neo-note">
              –¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞. 
              –° –ø–æ–º–æ—â—å—é —Å–ª–∞–π–¥–µ—Ä–∞ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ.
            </p>
        </div>

        <!-- –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É -->
    </div>
    
    <div id="map-container">
        <div id="map"></div>
        
        <!-- –ë–ª–æ–∫ –ø–æ–≥–æ–¥—ã (—Å–¥–≤–∏–Ω—É—Ç –ª–µ–≤–µ–µ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å—Å—è) -->
        <div id="weather-panel" style="position: absolute; right: 300px; top: 15px; z-index: 1000; padding: 10px; border-radius: 10px; background-color: rgba(var(--background-rgb), 1); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); pointer-events: auto;">
            <div id="weather-box">
                <div class="weather-header">
                    <span id="weather-icon">‚òÄÔ∏è</span>
                    <span id="weather-temp">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã...</span>
                </div>
                <div id="weather-description"></div>
                <div id="weather-recommendation"></div>
            </div>
            <div class="weather-controls">
                <div class="weather-tabs">
                    <button id="weather-tab-current" class="weather-tab active">–°–µ–π—á–∞—Å</button>
                    <button id="weather-tab-forecast" class="weather-tab">–ü—Ä–æ–≥–Ω–æ–∑</button>
                </div>
            </div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã (—Å–ø—Ä–∞–≤–∞) -->
        <div id="heatmap-panel">
            <h3>–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞</h3>
            <p style="font-size: 0.85em; margin-bottom: 10px; color: #666;">–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç–µ:</p>
            <div>
                <button id="heatmap-rating-button" class="neo-button">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</button>
                <button id="heatmap-density-button" class="neo-button">–ü–æ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏</button>
                <button id="heatmap-clear-button" class="neo-button">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div style="margin-top: 10px;">
                <select id="heatmap-type">
                    <option value="restaurant">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</option>
                    <option value="cafe">–ö–∞—Ñ–µ</option>
                    <option value="bar">–ë–∞—Ä—ã</option>
                    <option value="gym">–°–ø–æ—Ä—Ç–∑–∞–ª—ã</option>
                    <option value="pharmacy">–ê–ø—Ç–µ–∫–∏</option>
                    <option value="bank">–ë–∞–Ω–∫–∏</option>
                    <option value="school">–®–∫–æ–ª—ã</option>
                </select>
            </div>
        </div>
        
        <!-- –ë–ª–æ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö (–ø–æ–¥ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π, —Å–¥–≤–∏–Ω—É—Ç—ã –Ω–∏–∂–µ) -->
        <div id="route-info-container" style="position: absolute; right: 15px; top: 350px; z-index: 1000; width: 300px; pointer-events: none;">
            <div id="route-info" style="display: none; padding: 10px; border-radius: 10px; background-color: rgba(var(--background-rgb), 1); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); margin-bottom: 15px; pointer-events: auto;">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ</h3>
                <div class="neo-info-box">
                    <p>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: <span id="info-distance"></span> –∫–º</p>
                    <p>–í—Ä–µ–º—è: <span id="info-time"></span> –º–∏–Ω.</p>
                    <p>–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞: <span id="route-type">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</span></p>
                    <button id="save-route" class="neo-button success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
                    <div id="route-description"></div>
                </div>
            </div>
            
            <div id="route-info-panel" style="display: none; padding: 10px; border-radius: 10px; background-color: rgba(var(--background-rgb), 1); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); pointer-events: auto;">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ</h3>
                <div class="neo-info-box">
                    <p>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: <span id="cultural-info-distance"></span> –∫–º</p>
                    <p>–í—Ä–µ–º—è: <span id="cultural-info-time"></span> –º–∏–Ω.</p>
                    <p>–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞: <span id="cultural-route-type" style="color: #4CAF50;">–ö—É–ª—å—Ç—É—Ä–Ω—ã–π</span></p>
                    <button id="save-cultural-route" class="neo-button success" style="background-color: #2ecc71; color: white; width: 100%; padding: 10px; margin: 10px 0; border: none; border-radius: 5px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
                    <div id="cultural-route-description" style="margin-top: 15px; padding: 15px; border-radius: 10px; background-color: rgba(var(--background-rgb), 1); box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light); font-size: 0.9rem; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ -->
    <div id="neo-dialog-overlay" class="neo-dialog-overlay">
        <div id="neo-dialog" class="neo-dialog"></div>
    </div>
    
    <script>
        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
        const NeoDialog = {
            overlay: document.getElementById('neo-dialog-overlay'),
            dialog: document.getElementById('neo-dialog'),
            
            // –ü–æ–∫–∞–∑ alert-–¥–∏–∞–ª–æ–≥–∞
            alert: function(title, message, callback = null) {
                const content = `
                    <div class="neo-dialog-header">
                        <h3 class="neo-dialog-title">${title}</h3>
                    </div>
                    <div class="neo-dialog-content">${message}</div>
                    <div class="neo-dialog-buttons">
                        <button class="primary" id="neo-dialog-ok">–û–ö</button>
                    </div>
                `;
                
                this.dialog.innerHTML = content;
                this.overlay.classList.add('active');
                
                const okButton = document.getElementById('neo-dialog-ok');
                if (okButton) {
                    okButton.onclick = () => {
                        this.close();
                        if (callback) callback(true);
                    };
                    
                    // –§–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫–µ
                    setTimeout(() => okButton.focus(), 100);
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.close();
                        if (callback) callback(true);
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            },
            
            // –ü–æ–∫–∞–∑ confirm-–¥–∏–∞–ª–æ–≥–∞
            confirm: function(title, message, callback) {
                const content = `
                    <div class="neo-dialog-header">
                        <h3 class="neo-dialog-title">${title}</h3>
                    </div>
                    <div class="neo-dialog-content">${message}</div>
                    <div class="neo-dialog-buttons">
                        <button class="secondary" id="neo-dialog-cancel">–û—Ç–º–µ–Ω–∞</button>
                        <button class="primary" id="neo-dialog-confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    </div>
                `;
                
                this.dialog.innerHTML = content;
                this.overlay.classList.add('active');
                
                const cancelButton = document.getElementById('neo-dialog-cancel');
                const confirmButton = document.getElementById('neo-dialog-confirm');
                
                // –û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                const clearHandlers = () => {
                    if (cancelButton) cancelButton.onclick = null;
                    if (confirmButton) confirmButton.onclick = null;
                    document.removeEventListener('keydown', escHandler);
                };
                
                if (cancelButton) {
                    cancelButton.onclick = () => {
                        clearHandlers();
                        this.close();
                        callback(false);
                    };
                }
                
                if (confirmButton) {
                    confirmButton.onclick = () => {
                        clearHandlers();
                        this.close();
                        callback(true);
                    };
                    
                    // –§–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                    setTimeout(() => confirmButton.focus(), 100);
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        clearHandlers();
                        this.close();
                        callback(false);
                    }
                };
                document.addEventListener('keydown', escHandler);
            },
            
            // –ü–æ–∫–∞–∑ prompt-–¥–∏–∞–ª–æ–≥–∞
            prompt: function(title, message, defaultValue = '', callback) {
                const content = `
                    <div class="neo-dialog-header">
                        <h3 class="neo-dialog-title">${title}</h3>
                    </div>
                    <div class="neo-dialog-content">
                        ${message}
                        <div class="neo-input-group">
                            <input type="text" id="neo-dialog-input" class="neo-input" value="${defaultValue}">
                        </div>
                    </div>
                    <div class="neo-dialog-buttons">
                        <button class="secondary" id="neo-dialog-cancel">–û—Ç–º–µ–Ω–∞</button>
                        <button class="primary" id="neo-dialog-confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    </div>
                `;
                
                this.dialog.innerHTML = content;
                this.overlay.classList.add('active');
                
                const inputEl = document.getElementById('neo-dialog-input');
                const cancelButton = document.getElementById('neo-dialog-cancel');
                const confirmButton = document.getElementById('neo-dialog-confirm');
                
                // –û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                const clearHandlers = () => {
                    if (inputEl) inputEl.onkeydown = null;
                    if (cancelButton) cancelButton.onclick = null;
                    if (confirmButton) confirmButton.onclick = null;
                    document.removeEventListener('keydown', escHandler);
                };
                
                if (inputEl) {
                    setTimeout(() => inputEl.focus(), 100);
                    
                    inputEl.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            clearHandlers();
                            this.close();
                            callback(inputEl.value);
                        }
                    };
                }
                
                if (cancelButton) {
                    cancelButton.onclick = () => {
                        clearHandlers();
                        this.close();
                        callback(null);
                    };
                }
                
                if (confirmButton) {
                    confirmButton.onclick = () => {
                        clearHandlers();
                        this.close();
                        callback(inputEl ? inputEl.value : null);
                    };
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        clearHandlers();
                        this.close();
                        callback(null);
                    }
                };
                document.addEventListener('keydown', escHandler);
            },
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞
            close: function() {
                this.overlay.classList.remove('active');
                
                // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                setTimeout(() => {
                    // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
                    if (this.dialog) {
                        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–ª–æ–≥–∞
                        const buttons = this.dialog.querySelectorAll('button');
                        buttons.forEach(button => {
                            button.onclick = null;
                        });
                        
                        const inputs = this.dialog.querySelectorAll('input');
                        inputs.forEach(input => {
                            input.onkeydown = null;
                        });
                        
                        // –û—á–∏—â–∞–µ–º HTML
                        this.dialog.innerHTML = '';
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥—Ä—É–≥–∏—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
                        const activeModals = document.querySelectorAll('.neo-modal-container.active, .neo-dialog-overlay.active');
                        console.log(`–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω: ${activeModals.length}`);
                        
                        // –£–¥–∞–ª—è–µ–º –≤—Å–µ "–∑–∞–≤–∏—Å—à–∏–µ" –ø—É—Å—Ç—ã–µ –¥–∏–∞–ª–æ–≥–∏
                        const emptyDialogs = document.querySelectorAll('.neo-dialog:empty');
                        emptyDialogs.forEach(dialog => {
                            const overlay = dialog.closest('.neo-dialog-overlay');
                            if (overlay) {
                                overlay.classList.remove('active');
                                console.log('–£–¥–∞–ª–µ–Ω –∑–∞–≤–∏—Å—à–∏–π –ø—É—Å—Ç–æ–π –¥–∏–∞–ª–æ–≥');
                            }
                        });
                    }
                }, 300);
            }
        };
        
        // –ó–∞–º–µ–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –Ω–∞ –Ω–µ–æ–º–æ—Ä—Ñ–Ω—ã–µ
        window.originalAlert = window.alert;
        window.alert = function(message) {
            NeoDialog.alert('–í–Ω–∏–º–∞–Ω–∏–µ', message);
        };
        
        window.originalConfirm = window.confirm;
        window.confirm = function(message) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Promise –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
            return new Promise(resolve => {
                NeoDialog.confirm('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', message, result => {
                    resolve(result);
                });
            });
        };
        
        window.originalPrompt = window.prompt;
        window.prompt = function(message, defaultValue = '') {
            return new Promise(resolve => {
                NeoDialog.prompt('–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö', message, defaultValue, result => {
                    resolve(result);
                });
            });
        };
        
        // Theme switcher
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            // Check if user has a theme preference in localStorage
            const savedTheme = localStorage.getItem('mapmaker-theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
            }
            
            // Toggle theme
            themeToggle.addEventListener('click', function() {
                if (document.body.classList.contains('dark-theme')) {
                    // Switch to light theme
                    document.body.classList.remove('dark-theme');
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
                    localStorage.setItem('mapmaker-theme', 'light');
                    setMapStyle(false); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤–µ—Ç–ª—É—é –∫–∞—Ä—Ç—É
                } else {
                    // Switch to dark theme
                    document.body.classList.add('dark-theme');
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
                    localStorage.setItem('mapmaker-theme', 'dark');
                    setMapStyle(true); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º–Ω—É—é –∫–∞—Ä—Ç—É
                }
            });
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        document.addEventListener('DOMContentLoaded', function() {
            // –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            checkAuthStatus();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É, –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            setInterval(checkAuthStatus, 1000);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∫–ª–∏–∫–æ–≤
            const heatmapButtons = document.querySelectorAll('#heatmap-panel button, #heatmap-panel select');
            heatmapButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞—Ç–µ–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ –ø–æ–≥–æ–¥—ã
            const weatherPanel = document.getElementById('weather-panel');
            if (weatherPanel) {
                weatherPanel.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                weatherPanel.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                });
                weatherPanel.style.pointerEvents = 'auto';
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞—Ç–µ–ª–∏ –¥–ª—è –±–ª–æ–∫–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ
            const routeInfoElements = document.querySelectorAll('#route-info, #route-info-panel, .neo-info-box, #route-description, #cultural-route-description');
            routeInfoElements.forEach(element => {
                if (element) {
                    element.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                    element.addEventListener('dblclick', function(e) {
                        e.stopPropagation();
                    });
                    element.style.pointerEvents = 'auto';
                }
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Å–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ
            if (document.getElementById('category-cultural').classList.contains('active')) {
                // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ö—É–ª—å—Ç—É—Ä–∞", —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
                hideThematicRouteElements();
            } else {
                // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
                showThematicRouteElements();
            }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        window.debugAuth = function() {
            const userDataStr = localStorage.getItem('userData');
            console.log('Debug - userData –≤ localStorage:', userDataStr);
            
            const authContainer = document.getElementById('auth-container');
            console.log('Debug - authContainer:', authContainer);
            console.log('Debug - authContainer display:', authContainer ? authContainer.style.display : 'element not found');
            
            const userProfile = document.getElementById('user-profile');
            console.log('Debug - userProfile:', userProfile);
            console.log('Debug - userProfile display:', userProfile ? userProfile.style.display : 'element not found');
            
            const userName = document.getElementById('user-name');
            console.log('Debug - userName:', userName);
            console.log('Debug - userName content:', userName ? userName.textContent : 'element not found');
            
            console.log('Debug - isAuthenticated:', window.personalizationModule ? window.personalizationModule.isAuthenticated : 'module not found');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function checkAuthStatus() {
            console.log('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userDataStr = localStorage.getItem('userData');
            
            const authContainer = document.getElementById('auth-container');
            const userProfile = document.getElementById('user-profile');
            const userName = document.getElementById('user-name');
            
            if (userDataStr) {
                try {
                    const userData = JSON.parse(userDataStr);
                    
                    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                    if (authContainer) {
                        authContainer.style.display = 'none';
                    }
                    
                    if (userProfile) {
                        userProfile.style.display = 'block';
                    }
                    
                    if (userName) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—é, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        let displayName = userData.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                        if (userData.firstName && userData.firstName.trim() !== '') {
                            displayName = userData.firstName;
                            if (userData.lastName && userData.lastName.trim() !== '') {
                                displayName += ' ' + userData.lastName;
                            }
                        }
                        userName.textContent = displayName;
                        userName.style.fontWeight = 'bold';
                        userName.style.color = '#4285f4';
                    }
                    
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', userData.username);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è personalizationModule
                    if (window.personalizationModule) {
                        window.personalizationModule.isAuthenticated = true;
                        window.personalizationModule.userProfile = userData;
                    }
                    
                    return true;
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                    localStorage.removeItem('userData'); // –£–¥–∞–ª—è–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                }
            }
            
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞
            if (authContainer) {
                authContainer.style.display = 'block';
            }
            
            if (userProfile) {
                userProfile.style.display = 'none';
            }
            
            return false;
        }
        
        const map = L.map('map-container').setView([55.19, 30.20], 13);
        let routeLayer = null; // –°–ª–æ–π –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        let startMarker = null;
        let endMarker = null;
        let startPoint = null; // {lat, lng}
        let endPoint = null;   // {lat, lng}
        let currentProfile = 'foot'; // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
        let currentPoiType = 'restaurant'; // –¢–∏–ø —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let poiMarkers = []; // –ú–∞—Å—Å–∏–≤ –º–∞—Ä–∫–µ—Ä–æ–≤ POI –¥–ª—è —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
        let currentPois = [];
        let selectedPoisIndexes = new Set();
        let tileLayer; // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Å–ª–æ—è –∫–∞—Ä—Ç—ã

        // –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç
        const lightMapUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const darkMapUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∏–ª—è –∫–∞—Ä—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
        function setMapStyle(isDark) {
            if (tileLayer) {
                map.removeLayer(tileLayer);
            }
            
            const mapUrl = isDark ? darkMapUrl : lightMapUrl;
            const attribution = isDark 
                ? '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
                : '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
                
            tileLayer = L.tileLayer(mapUrl, {
                maxZoom: 19,
                attribution: attribution
            }).addTo(map);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–º—É –≤ localStorage –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∏–ª—å –∫–∞—Ä—Ç—ã
        const savedTheme = localStorage.getItem('mapmaker-theme');
        setMapStyle(savedTheme === 'dark');

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã UI --- 
        const routeInfoPanel = document.getElementById('route-info-panel');
        const routeSummary = document.querySelector('#route-info-panel .route-summary');
        const routePointsList = document.querySelector('#route-info-panel .route-points-list');
        const saveCulturalRouteButton = document.getElementById('save-cultural-route');
        const routeInfo = document.getElementById('route-info');
        const infoDistance = document.getElementById('info-distance');
        const infoTime = document.getElementById('info-time');
        const routeDescription = document.getElementById('route-description');
        const profileButtons = document.getElementById('profile-buttons');
        const resetButton = document.getElementById('reset-button');
        const poiButtons = document.getElementById('poi-buttons');
        const thematicRouteButton = document.getElementById('thematic-route-button');
        const poiCountSlider = document.getElementById('poi-count-slider');
        const poiCountValue = document.getElementById('poi-count-value');
        const shufflePoiButton = document.getElementById('shuffle-poi-button');
        const saveRouteButton = document.getElementById('save-route');

        // --- –§—É–Ω–∫—Ü–∏–∏ ----

        // –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã –æ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –º–∞—Ä–∫–µ—Ä–æ–≤
        function clearMap() {
            console.log('–í—ã–∑–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è clearMap()');
            
            // –£–¥–∞–ª—è–µ–º —Å–ª–æ–π –º–∞—Ä—à—Ä—É—Ç–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (routeLayer) {
                console.log('–£–¥–∞–ª—è—é —Å–ª–æ–π –º–∞—Ä—à—Ä—É—Ç–∞');
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            // –û—á–∏—â–∞–µ–º POI –º–∞—Ä–∫–µ—Ä—ã
            clearPoiMarkers();
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –∫—É–ª—å—Ç—É—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
            if (typeof clearCulturalRoute === 'function') {
                clearCulturalRoute();
            }
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ç–µ–ø–ª–æ–≤—ã–µ –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if (window.heatmapLayer && typeof window.heatmapLayer.remove === 'function') {
                window.heatmapLayer.remove();
                window.heatmapLayer = null;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–∞—Ä—à—Ä—É—Ç–µ
            const routeInfoPanel = document.getElementById('route-info-panel');
            if (routeInfoPanel) routeInfoPanel.style.display = 'none';
            
            const routeInfo = document.getElementById('route-info');
            if (routeInfo) routeInfo.style.display = 'none';
            
            console.log('–ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞ –æ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –º–∞—Ä–∫–µ—Ä–æ–≤');
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ POI
        function clearPoiMarkers() {
            poiMarkers.forEach(marker => map.removeLayer(marker));
            poiMarkers = [];
        }

        // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –≤—Å–µ—Ö —Ç–æ—á–µ–∫ 
        function fullResetPoints() {
            console.log('–í—ã–∑–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è fullResetPoints() –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞');
            
            // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
            }
            
            if (endMarker) {
                map.removeLayer(endMarker);
                endMarker = null;
            }
            
            // –£–¥–∞–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            // –û—á–∏—â–∞–µ–º POI –º–∞—Ä–∫–µ—Ä—ã
            clearPoiMarkers();
            
            // –û—á–∏—â–∞–µ–º –∫—É–ª—å—Ç—É—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
            if (typeof clearCulturalRoute === 'function') {
                clearCulturalRoute();
            } else if (window.culturalRouteLayer) {
                // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                map.removeLayer(window.culturalRouteLayer);
                window.culturalRouteLayer = null;
                
                // –û—á–∏—â–∞–µ–º –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (window.culturalMarkers && window.culturalMarkers.length > 0) {
                    window.culturalMarkers.forEach(marker => map.removeLayer(marker));
                    window.culturalMarkers = [];
                }
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ—á–∫–∏ –ê –∏ –ë
            startPoint = null;
            endPoint = null;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ
            hideAllRouteInfo();
            
            console.log('–í—Å–µ —Ç–æ—á–∫–∏ –∏ –º–∞—Ä—à—Ä—É—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—à–µ–Ω—ã');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–∞–Ω–µ–ª–µ–π –º–∞—Ä—à—Ä—É—Ç–æ–≤
        function hideAllRouteInfo() {
            const routeInfo = document.getElementById('route-info');
            if (routeInfo) routeInfo.style.display = 'none';
            
            const routeInfoPanel = document.getElementById('route-info-panel');
            if (routeInfoPanel) routeInfoPanel.style.display = 'none';
        }
        
        // –°–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç–∞, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –ê –∏ –ë
        function resetPoints() {
            clearMap();
            
            // –ï—Å–ª–∏ —Ç–æ—á–∫–∏ –ê –∏ –ë —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö –º–∞—Ä–∫–µ—Ä—ã
            if (startPoint) {
                if (!startMarker) {
                    startMarker = L.marker([startPoint.lat, startPoint.lng], {
                        icon: L.divIcon({className: 'route-marker-start', html: 'A', iconSize: [24, 24], iconAnchor: [12, 24]})
                    }).addTo(map);
                }
            }
            
            if (endPoint) {
                if (!endMarker) {
                    endMarker = L.marker([endPoint.lat, endPoint.lng], {
                        icon: L.divIcon({className: 'route-marker-end', html: 'B', iconSize: [24, 24], iconAnchor: [12, 24]})
                    }).addTo(map);
                }
                
                // –£–¥–∞–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç, –æ–Ω –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —Å–∞–º
            }
             
            console.log('–ú–∞—Ä—à—Ä—É—Ç —Å–±—Ä–æ—à–µ–Ω, —Ç–æ—á–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        function displayRoute(routeData, poiData) {
            console.log('–í—ã–∑–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è displayRoute –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            // –û—á–∏—â–∞–µ–º POI –º–∞—Ä–∫–µ—Ä—ã
            clearPoiMarkers();

            if (routeData && routeData.paths && routeData.paths.length > 0) {
                const path = routeData.paths[0];
                const coordinates = path.points.coordinates;
                const latLngs = coordinates.map(coord => [coord[1], coord[0]]);

                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏–ª–∏–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞ —Å —Ü–≤–µ—Ç–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ñ–∏–ª—è
                routeLayer = L.polyline(latLngs, { 
                    color: getRouteColor(currentProfile), 
                    weight: 4,
                    opacity: 0.8
                }).addTo(map);
                
                console.log(`–°–æ–∑–¥–∞–Ω —Å–ª–æ–π –º–∞—Ä—à—Ä—É—Ç–∞ —Å ${latLngs.length} —Ç–æ—á–∫–∞–º–∏`);
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ—á–∫–∞—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –∫–∞–∫ –º–∞—Ä–∫–µ—Ä—ã
                if (poiData && poiData.length > 0) {
                    console.log(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ ${poiData.length} —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞`);
                    poiData.forEach((poi, index) => {
                        const marker = L.marker([poi.latitude, poi.longitude], {
                            icon: L.divIcon({
                                className: 'route-marker-poi',
                                html: `<div style="
                                    width: 24px;
                                    height: 24px;
                                    border-radius: 50%;
                                    background-color: #2196F3;
                                    color: white;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    font-weight: bold;
                                    border: 2px solid white;
                                    box-shadow: 0 0 4px rgba(0,0,0,0.5);">${index + 1}</div>`,
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ø–æ–ø–∞–ø
                        let popupContent = `<b>${poi.name}</b>`;
                        if (poi.rating) popupContent += `<br>–†–µ–π—Ç–∏–Ω–≥: ${poi.rating}`;
                        if (poi.address) popupContent += `<br>–ê–¥—Ä–µ—Å: ${poi.address}`;
                        if (poi.vicinity) popupContent += `<br>–†–∞–π–æ–Ω: ${poi.vicinity}`;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
                        if (poi.photoUrl) {
                            popupContent += `<br><img src="${poi.photoUrl}" alt="${poi.name}" style="max-width: 200px; max-height: 150px; margin-top: 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">`;
                        }
                        
                        marker.bindPopup(popupContent);
                        poiMarkers.push(marker);
                    });

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
                    let descriptionHtml = '<h4>–û–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞:</h4><ol>';
                    poiData.forEach((poi, index) => {
                        let poiDescription = `<li><b>${poi.name}</b> - ${poi.type}`;
                        if (poi.rating) poiDescription += `, —Ä–µ–π—Ç–∏–Ω–≥: ${poi.rating}`;
                        if (poi.vicinity) poiDescription += `, —Ä–∞–π–æ–Ω: ${poi.vicinity}`;
                        if (poi.address) poiDescription += `, –∞–¥—Ä–µ—Å: ${poi.address}`;
                        poiDescription += '</li>';
                        descriptionHtml += poiDescription;
                    });
                    descriptionHtml += '</ol>';
                    routeDescription.innerHTML = descriptionHtml;
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                if (!startMarker) {
                    startMarker = L.marker(latLngs[0], {
                        icon: L.divIcon({className: 'route-marker-start', html: 'A', iconSize: [24, 24], iconAnchor: [12, 24]})
                    }).addTo(map);
                }
                
                if (!endMarker) {
                    endMarker = L.marker(latLngs[latLngs.length - 1], {
                        icon: L.divIcon({className: 'route-marker-end', html: 'B', iconSize: [24, 24], iconAnchor: [12, 24]})
                    }).addTo(map);
                }

                map.fitBounds(routeLayer.getBounds());

                const distanceKm = (path.distance / 1000).toFixed(2);
                const timeMin = Math.round(path.time / 1000 / 60);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –º–∞—Ä—à—Ä—É—Ç–µ
                infoDistance.textContent = distanceKm;
                infoTime.textContent = timeMin;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –º–∞—Ä—à—Ä—É—Ç–µ
                showThematicRouteInfo();

                console.log(`–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω: ${distanceKm} –∫–º, ${timeMin} –º–∏–Ω.`);
            } else {
                console.error("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç.", routeData);
                NeoDialog.alert("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç. –û—Ç–≤–µ—Ç API –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—É—Ç–∏.");
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –∏ —Å–∫—Ä—ã—Ç–∏—è –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ
        function showThematicRouteInfo() {
            // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ
            hideAllRouteInfo();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç
            const routeInfo = document.getElementById('route-info');
            if (routeInfo) routeInfo.style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –∏ —Å–∫—Ä—ã—Ç–∏—è —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ
        function showCulturalRouteInfo() {
            // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ
            hideAllRouteInfo();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—É–ª—å—Ç—É—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
            const routeInfoPanel = document.getElementById('route-info-panel');
            if (routeInfoPanel) routeInfoPanel.style.display = 'block';
        }

        // –ó–∞–ø—Ä–æ—Å –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        function getAndDisplayRoute(startLat, startLon, endLat, endLon, profile) {
            console.log(`–ó–∞–ø—Ä–æ—Å –º–∞—Ä—à—Ä—É—Ç–∞: A(${startLat},${startLon}) -> B(${endLat},${endLon}), –ü—Ä–æ—Ñ–∏–ª—å: ${profile}`);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'route-loading';
            loadingIndicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 15px;
                border-radius: 10px;
                z-index: 1000;
            `;
            loadingIndicator.innerHTML = '–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...';
            document.body.appendChild(loadingIndicator);
            
            fetch(`/api/route?startLat=${startLat}&startLon=${startLon}&endLat=${endLat}&endLon=${endLon}&profile=${profile}`)
                .then(response => {
                    if (!response.ok) {
                        // –ü–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–ª–æ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                        return response.text().then(text => { 
                            throw new Error(`HTTP error! status: ${response.status}, message: ${text}`); 
                        });
                    }
                    return response.json(); 
                })
                .then(data => {
                    // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    const loadingElem = document.getElementById('route-loading');
                    if (loadingElem) document.body.removeChild(loadingElem);
                    
                    displayRoute(data);
                })
                .catch(error => {
                    // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    const loadingElem = document.getElementById('route-loading');
                    if (loadingElem) document.body.removeChild(loadingElem);
                    
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    NeoDialog.alert('–û—à–∏–±–∫–∞', `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞: ${error.message}`);
                    
                    // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º —Å–±—Ä–æ—Å —Ç–æ—á–µ–∫, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ç–æ—á–∫–∏ –ê –∏ –ë
                    // –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
                });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
        function getPois(type) {
            console.log('–ó–∞–ø—Ä–æ—Å POI —Ç–∏–ø–∞:', type);
            
            // GraphHopper API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—á–∫—É –æ—Ç—Å—á–µ—Ç–∞ 55.19, 30.20 - —ç—Ç–æ —Ü–µ–Ω—Ç—Ä –í–∏—Ç–µ–±—Å–∫–∞
            // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ POI –≤ —Ä–∞–¥–∏—É—Å–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ –≥–æ—Ä–æ–¥–∞
            return fetch(`/api/pois?types=${type}`)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error! status: ${response.status}, message: ${text || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è'}`);
                        });
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ POI:', error);
                    NeoDialog.alert('–û—à–∏–±–∫–∞', `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞: ${error.message}`);
                    return [];
                });
        }
        
        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ —Å —É—á–µ—Ç–æ–º —Ç–µ–º–ø–∞ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        async function buildThematicRoute() {
            clearMap();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ –Ω–∞—á–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä
            if (!startPoint) {
                NeoDialog.alert('–í–Ω–∏–º–∞–Ω–∏–µ', '–°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∞, –∫–ª–∏–∫–Ω—É–≤ –Ω–∞ –∫–∞—Ä—Ç—É');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –∏–∑ —Å–ª–∞–π–¥–µ—Ä–∞
            let poiCount = parseInt(poiCountSlider.value);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'route-loading-indicator';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px;
                border-radius: 10px;
                z-index: 1000;
                text-align: center;
            `;
            loadingDiv.innerHTML = `
                <div style="
                    border: 4px solid rgba(255, 255, 255, 0.3);
                    border-top: 4px solid white;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    margin: 0 auto 15px auto;
                    animation: spin 1s linear infinite;
                "></div>
                <div>–°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç –æ—Ç –≤–∞—à–µ–π —Ç–æ—á–∫–∏...</div>
            `;
            document.body.appendChild(loadingDiv);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º API —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ POI
            const isCulturalCategory = document.getElementById('category-cultural').classList.contains('active');
            const apiEndpoint = isCulturalCategory ? '/api/cultural-pois' : '/api/pois';
            
            // –ü–æ–ª—É—á–∞–µ–º POI –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ POI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–∏–ø–∞
                const poiUrl = `${apiEndpoint}?types=${currentPoiType}`;
                console.log(`–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞: ${poiUrl}`);
                
                const response = await fetch(poiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                let pois = await response.json();
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ—á–∫–∏ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º 4.0 –∏ –≤—ã—à–µ
                const highRatedPois = pois.filter(poi => poi.rating && poi.rating >= 4.0);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                if (highRatedPois.length < 3) {
                    console.log('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫ —Å –≤—ã—Å–æ–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ—á–∫–∏');
                    // –ï—Å–ª–∏ —Ç–æ—á–µ–∫ —Å –≤—ã—Å–æ–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –∏ –±–µ—Ä–µ–º –ª—É—á—à–∏–µ
                    pois.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∏ —Å –≤—ã—Å–æ–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º
                    pois = highRatedPois;
                    console.log(`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${highRatedPois.length} —Ç–æ—á–µ–∫ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º 4.0+`);
                }
                
                if (pois.length < 3) {
                    document.body.removeChild(loadingDiv);
                    NeoDialog.alert('–í–Ω–∏–º–∞–Ω–∏–µ', `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫ —Ç–∏–ø–∞ ${currentPoiType} –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3)`);
                    return;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ POI –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –ø–æ–∑–∂–µ
                currentPois = pois;
                
                // –í—ã–±–∏—Ä–∞–µ–º –∑–∞–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å —Ç–æ—á–µ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –∫ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º—É –º–∞—Ä–∫–µ—Ä—É
                let selectedPois = [];
                selectedPoisIndexes = new Set();
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –ø–æ —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Ç–æ—á–∫–∏
                pois.forEach((poi, index) => {
                    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Ç–æ—á–∫–∏
                    poi.distanceToStart = calculateDistance(
                        startPoint.lat, startPoint.lng,
                        poi.latitude, poi.longitude
                    );
                    poi.originalIndex = index;
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
                pois.sort((a, b) => a.distanceToStart - b.distanceToStart);
                
                // –ë–µ—Ä–µ–º –±–ª–∏–∂–∞–π—à–∏–µ —Ç–æ—á–∫–∏ (–Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ - –º–∏–Ω–∏–º—É–º 100 –º–µ—Ç—Ä–æ–≤ –æ—Ç —Å—Ç–∞—Ä—Ç–∞)
                const minDistanceKm = 0.1; // 100 –º–µ—Ç—Ä–æ–≤ –≤ –∫–º
                const nearbyPois = pois.filter(poi => poi.distanceToStart >= minDistanceKm);
                
                if (nearbyPois.length === 0) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–µ–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è, –±–µ—Ä–µ–º –±–ª–∏–∂–∞–π—à–∏–µ
                    selectedPois = pois.slice(0, Math.min(poiCount, pois.length));
                } else {
                    // –ë–µ—Ä–µ–º —Ç–æ—á–∫–∏ –∏–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
                    selectedPois = nearbyPois.slice(0, Math.min(poiCount, nearbyPois.length));
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫
                selectedPois.forEach(poi => {
                    selectedPoisIndexes.add(poi.originalIndex);
                });
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞, –Ω–∞—á–∏–Ω–∞—è —Å–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const pointsStr = `${startPoint.lat},${startPoint.lng};` + 
                                  selectedPois.map(poi => `${poi.latitude},${poi.longitude}`).join(';');
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
                const routeResponse = await fetch(`/api/thematic-route?points=${pointsStr}&profile=${currentProfile}`);
                
                if (!routeResponse.ok) {
                    const errorText = await routeResponse.text();
                    throw new Error(`HTTP error! status: ${routeResponse.status}, message: ${errorText}`);
                }
                
                const data = await routeResponse.json();
                
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                document.body.removeChild(loadingDiv);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ –º–∞—Ä—à—Ä—É—Ç–∞
                document.getElementById('route-type').textContent = `–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (—Ç–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º 4+)`;
                document.getElementById('route-type').style.color = '#4CAF50';
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                displayRoute(data, selectedPois);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ
                const routeInfo = document.getElementById('route-info');
                if (routeInfo) {
                    routeInfo.style.display = 'block';
                }
                
            } catch (error) {
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                if (document.getElementById('route-loading-indicator')) {
                    document.body.removeChild(document.getElementById('route-loading-indicator'));
                }
                
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                NeoDialog.alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞: ${error.message}`);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è —Ç–æ—á–µ–∫ —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        async function shufflePois() {
            if (!currentPois || currentPois.length === 0) {
                NeoDialog.alert('–í–Ω–∏–º–∞–Ω–∏–µ', '–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ –Ω–∞—á–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä
            if (!startPoint) {
                NeoDialog.alert('–í–Ω–∏–º–∞–Ω–∏–µ', '–°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∞, –∫–ª–∏–∫–Ω—É–≤ –Ω–∞ –∫–∞—Ä—Ç—É');
                return;
            }
            
            clearMap();
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –∏–∑ —Å–ª–∞–π–¥–µ—Ä–∞
            const poiCount = parseInt(poiCountSlider.value);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ—á–∫–∏ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É 4.0+
            const highRatedPois = currentPois.filter(poi => poi.rating && poi.rating >= 4.0);
            let pois = highRatedPois.length >= 3 ? highRatedPois : currentPois;
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –ø–æ —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
            pois.forEach((poi, index) => {
                poi.distanceToStart = calculateDistance(
                    startPoint.lat, startPoint.lng,
                    poi.latitude, poi.longitude
                );
                poi.originalIndex = index;
            });
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Ç–æ—á–∫–∏, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
            const shuffled = [...pois].sort(() => Math.random() - 0.5);
            
            // –ë–µ—Ä–µ–º –±–ª–∏–∂–∞–π—à–∏–µ —Ç–æ—á–∫–∏, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Ç–æ—á–∫–µ
            const minDistanceKm = 0.1; // 100 –º–µ—Ç—Ä–æ–≤ –≤ –∫–º
            const eligiblePois = shuffled.filter(poi => poi.distanceToStart >= minDistanceKm);
            
            // –í—ã–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞
            let selectedPois = [];
            if (eligiblePois.length >= poiCount) {
                selectedPois = eligiblePois.slice(0, poiCount);
            } else {
                // –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫, –±–µ—Ä–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
                selectedPois = shuffled.slice(0, Math.min(poiCount, shuffled.length));
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
            selectedPoisIndexes = new Set();
            selectedPois.forEach(poi => {
                if (poi.originalIndex !== undefined) {
                    selectedPoisIndexes.add(poi.originalIndex);
                }
            });
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞, –Ω–∞—á–∏–Ω–∞—è —Å–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Ç–æ—á–∫–∏
            const pointsStr = `${startPoint.lat},${startPoint.lng};` + 
                              selectedPois.map(poi => `${poi.latitude},${poi.longitude}`).join(';');
            
            try {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'shuffle-loading-indicator';
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background-color: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    z-index: 1000;
                    text-align: center;
                `;
                loadingDiv.innerHTML = `
                    <div style="
                        border: 4px solid rgba(255, 255, 255, 0.3);
                        border-top: 4px solid white;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        margin: 0 auto 15px auto;
                        animation: spin 1s linear infinite;
                    "></div>
                    <div>–ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Ç–æ—á–∫–∏ –∏ —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç –æ—Ç –≤–∞—à–µ–π —Ç–æ—á–∫–∏...</div>
                `;
                document.body.appendChild(loadingDiv);
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
                const response = await fetch(`/api/thematic-route?points=${pointsStr}&profile=${currentProfile}`);
                
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                document.body.removeChild(loadingDiv);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const data = await response.json();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ –º–∞—Ä—à—Ä—É—Ç–∞
                document.getElementById('route-type').textContent = `–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (—Ç–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º 4+)`;
                document.getElementById('route-type').style.color = '#4CAF50';
                
                displayRoute(data, selectedPois);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                NeoDialog.alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞: ${error.message}`);
                
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –µ—Å–ª–∏ –æ–Ω –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (document.getElementById('shuffle-loading-indicator')) {
                    document.body.removeChild(document.getElementById('shuffle-loading-indicator'));
                }
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---

        // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–µ–∫ –ê –∏ –ë
        map.on('click', function(e) {
            const clickedLat = e.latlng.lat;
            const clickedLng = e.latlng.lng;
            
            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
            if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
            }
            
            if (endMarker) {
                map.removeLayer(endMarker);
                endMarker = null;
            }
            
            // –û—á–∏—â–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã POI –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ
            clearPoiMarkers();
            const routeInfo = document.getElementById('route-info');
            if (routeInfo) routeInfo.style.display = 'none';

            if (!startPoint) {
                // –í—ã–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É –ê (–ø–µ—Ä–≤—ã–π –∫–ª–∏–∫)
                console.log('–í—ã–±–æ—Ä —Ç–æ—á–∫–∏ –ê (–ø–µ—Ä–≤—ã–π –∫–ª–∏–∫)');
                startPoint = { lat: clickedLat, lng: clickedLng };
                startMarker = L.marker([clickedLat, clickedLng], {
                    icon: L.divIcon({className: 'route-marker-start', html: 'A', iconSize: [24, 24], iconAnchor: [12, 24]})
                }).addTo(map);
                console.log('–¢–æ—á–∫–∞ –ê –≤—ã–±—Ä–∞–Ω–∞:', startPoint);
            } else if (!endPoint) {
                // –í—ã–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É –ë –∏ —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
                console.log('–í—ã–±–æ—Ä —Ç–æ—á–∫–∏ –ë (–≤—Ç–æ—Ä–æ–π –∫–ª–∏–∫)');
                endPoint = { lat: clickedLat, lng: clickedLng };
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä —Ç–æ—á–∫–∏ –ê, –∫–æ—Ç–æ—Ä—ã–π –º—ã —É–¥–∞–ª–∏–ª–∏ –≤—ã—à–µ
                startMarker = L.marker([startPoint.lat, startPoint.lng], {
                    icon: L.divIcon({className: 'route-marker-start', html: 'A', iconSize: [24, 24], iconAnchor: [12, 24]})
                }).addTo(map);
                
                console.log('–¢–æ—á–∫–∞ –ë –≤—ã–±—Ä–∞–Ω–∞:', endPoint);
                getAndDisplayRoute(startPoint.lat, startPoint.lng, endPoint.lat, endPoint.lng, currentProfile);
            } else {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–æ—á–∫–∏ –∏ –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ —Å —Ç–æ—á–∫–∏ –ê
                console.log('–°–±—Ä–æ—Å —Ç–æ—á–µ–∫ –∏ –≤—ã–±–æ—Ä –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏ –ê');
                startPoint = { lat: clickedLat, lng: clickedLng };
                endPoint = null;
                
                // –°–æ–∑–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ä–∫–µ—Ä —Ç–æ—á–∫–∏ –ê
                startMarker = L.marker([clickedLat, clickedLng], {
                    icon: L.divIcon({className: 'route-marker-start', html: 'A', iconSize: [24, 24], iconAnchor: [12, 24]})
                }).addTo(map);
                
                console.log('–°—Ç–∞—Ä—ã–µ —Ç–æ—á–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã. –ù–æ–≤–∞—è —Ç–æ—á–∫–∞ –ê –≤—ã–±—Ä–∞–Ω–∞:', startPoint);
            }
        });

        // –í—ã–±–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
        profileButtons.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') {
                const selectedProfile = e.target.id.replace('profile-', '');
                if (selectedProfile !== currentProfile) {
                    currentProfile = selectedProfile;
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                    profileButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    console.log('–í—ã–±—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—å:', currentProfile);
                    // –ï—Å–ª–∏ —Ç–æ—á–∫–∏ –ê –∏ –ë —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã, –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
                    if (startPoint && endPoint) {
                        getAndDisplayRoute(startPoint.lat, startPoint.lng, endPoint.lat, endPoint.lng, currentProfile);
                    }
                }
            }
        });

        // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
        resetButton.addEventListener('click', function() {
            console.log('–ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –Ω–∞–∂–∞—Ç–∞, –≤—ã–∑—ã–≤–∞—é –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å —Ç–æ—á–µ–∫');
            fullResetPoints(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π POI
        document.getElementById('category-food').addEventListener('click', function() {
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–ï–¥–∞"
            document.getElementById('category-food').classList.add('active');
            document.getElementById('category-cultural').classList.remove('active');
            document.getElementById('poi-food-buttons').classList.add('active');
            document.getElementById('poi-cultural-buttons').classList.remove('active');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø POI –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ï–¥–∞"
            currentPoiType = 'restaurant';
            updateActivePoi('poi-restaurant');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
            showThematicRouteElements();
        });
        
        document.getElementById('category-cultural').addEventListener('click', function() {
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–ö—É–ª—å—Ç—É—Ä–∞"
            document.getElementById('category-cultural').classList.add('active');
            document.getElementById('category-food').classList.remove('active');
            document.getElementById('poi-cultural-buttons').classList.add('active');
            document.getElementById('poi-food-buttons').classList.remove('active');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø POI –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ö—É–ª—å—Ç—É—Ä–∞"
            currentPoiType = 'museum';
            updateActivePoi('poi-museum');
            
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
            hideThematicRouteElements();
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        function hideThematicRouteElements() {
            const elements = [
                document.getElementById('thematic-route-button'),
                document.getElementById('shuffle-poi-button'),
                document.getElementById('optimize-route-button')
            ];
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            elements.forEach(el => {
                if (el) {
                    el.style.opacity = '0';
                    setTimeout(() => {
                        el.style.display = 'none';
                        el.style.height = '0';
                        el.style.margin = '0';
                        el.style.padding = '0';
                    }, 300);
                }
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–ª–∞–π–¥–µ—Ä –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
            const sliderContainer = document.querySelector('.neo-slider:not(.cultural-route-block .neo-slider)');
            if (sliderContainer) {
                sliderContainer.style.opacity = '0';
                setTimeout(() => {
                    sliderContainer.style.display = 'none';
                    sliderContainer.style.height = '0';
                    sliderContainer.style.margin = '0';
                }, 300);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        function showThematicRouteElements() {
            const elements = [
                document.getElementById('thematic-route-button'),
                document.getElementById('shuffle-poi-button'),
                document.getElementById('optimize-route-button')
            ];
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            elements.forEach(el => {
                if (el) {
                    el.style.display = 'block';
                    el.style.height = '';
                    el.style.margin = '';
                    el.style.padding = '';
                    setTimeout(() => {
                        el.style.opacity = '1';
                    }, 10);
                }
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–∞–π–¥–µ—Ä –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
            const sliderContainer = document.querySelector('.neo-slider:not(.cultural-route-block .neo-slider)');
            if (sliderContainer) {
                sliderContainer.style.display = 'block';
                sliderContainer.style.height = '';
                sliderContainer.style.margin = '';
                setTimeout(() => {
                    sliderContainer.style.opacity = '1';
                }, 10);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ POI
        function updateActivePoi(poiId) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ –æ–±–µ–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö
            document.querySelectorAll('#poi-food-buttons button, #poi-cultural-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –î–µ–ª–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–Ω–æ–π
            const selectedButton = document.getElementById(poiId);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ï–¥–∞"
        document.querySelectorAll('#poi-food-buttons button').forEach(button => {
            button.addEventListener('click', function() {
                const selectedPoi = this.id.replace('poi-', '');
                currentPoiType = selectedPoi;
                updateActivePoi(this.id);
                console.log('–í—ã–±—Ä–∞–Ω —Ç–∏–ø —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞:', currentPoiType);
            });
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ö—É–ª—å—Ç—É—Ä–∞"
        document.querySelectorAll('#poi-cultural-buttons button').forEach(button => {
            button.addEventListener('click', function() {
                const selectedPoi = this.id.replace('poi-', '');
                currentPoiType = selectedPoi;
                updateActivePoi(this.id);
                console.log('–í—ã–±—Ä–∞–Ω —Ç–∏–ø —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞:', currentPoiType);
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–∞
        poiCountSlider.addEventListener('input', function() {
            poiCountValue.textContent = this.value;
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        if (thematicRouteButton) {
            thematicRouteButton.addEventListener('click', buildThematicRoute);
            console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω');
        }
        
        // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è —Ç–æ—á–µ–∫
        shufflePoiButton.addEventListener('click', shufflePois);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é buildOptimalThematicRoute –ø—Ä—è–º–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–∞–π–ª–µ
        async function buildOptimalThematicRoute() {
            console.log('–ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞');
            
            // –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
            clearMap();
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø POI –∏ –ø—Ä–æ—Ñ–∏–ª—å –º–∞—Ä—à—Ä—É—Ç–∞
            const poiType = currentPoiType;
            const profile = currentProfile;
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –∏–∑ —Å–ª–∞–π–¥–µ—Ä–∞
            const poiCount = parseInt(poiCountSlider.value);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px;
                border-radius: 10px;
                z-index: 1000;
                text-align: center;
            `;
            loadingDiv.innerHTML = `
                <div style="
                    border: 4px solid rgba(255, 255, 255, 0.3);
                    border-top: 4px solid white;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    margin: 0 auto 15px auto;
                    animation: spin 1s linear infinite;
                "></div>
                <div>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞...</div>
            `;
            document.body.appendChild(loadingDiv);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            if (!document.getElementById('loading-animation-style')) {
                const style = document.createElement('style');
                style.id = 'loading-animation-style';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ POI –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
                const response = await fetch(`/api/pois?types=${poiType}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è'}`);
                }
                
                const pois = await response.json();
                
                if (pois.length < 3) {
                    // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) loadingIndicator.remove();
                    
                    NeoDialog.alert('–í–Ω–∏–º–∞–Ω–∏–µ', `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫ —Ç–∏–ø–∞ "${poiType}" –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3)`);
                    return;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ POI
                currentPois = pois;
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º POI –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ
                let filteredPois = pois;
                if (pois[0].hasOwnProperty('rating')) {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É (–æ—Ç –≤—ã—Å—à–µ–≥–æ –∫ –Ω–∏–∑—à–µ–º—É)
                    filteredPois = pois.filter(poi => poi.rating > 0)
                                    .sort((a, b) => b.rating - a.rating);
                                    
                    // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–µ —Ç–æ—á–∫–∏ –µ—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ
                    if (filteredPois.length > poiCount * 3) {
                        filteredPois = filteredPois.slice(0, poiCount * 3);
                    }
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∂–∞–¥–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
                // –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É —Å –Ω–∞–∏–≤—ã—Å—à–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º
                const selectedPoisIndices = [0]; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏ (—Å–∞–º–æ–π –≤—ã—Å–æ–∫–æ—Ä–µ–π—Ç–∏–Ω–≥–æ–≤–æ–π)
                
                // –í—ã–±–∏—Ä–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –ø–æ –±–∞–ª–∞–Ω—Å—É —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                while (selectedPoisIndices.length < poiCount) {
                    let bestScore = -1;
                    let bestIndex = -1;
                    
                    for (let i = 0; i < filteredPois.length; i++) {
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
                        if (selectedPoisIndices.includes(i)) continue;
                        
                        // –°—á–∏—Ç–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫
                        let minDistance = Infinity;
                        for (const selectedIndex of selectedPoisIndices) {
                            const dist = calculateDistance(
                                filteredPois[selectedIndex].latitude, filteredPois[selectedIndex].longitude,
                                filteredPois[i].latitude, filteredPois[i].longitude
                            );
                            minDistance = Math.min(minDistance, dist);
                        }
                        
                        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ —Ç–æ—á–∫–∏
                        const rating = filteredPois[i].rating || 3; // –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–∏–π —Å–∫–æ—Ä (–∫–æ–º–±–∏–Ω–∞—Ü–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è)
                        // –í—ã—Å–æ–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥ - –ª—É—á—à–µ, –±–æ–ª—å—à–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ - —Ö—É–∂–µ
                        const ratingWeight = 0.7;
                        const distanceWeight = 0.3;
                        
                        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
                        const normalizedRating = rating / 5; // –û—Ç 0 –¥–æ 1
                        const normalizedDistance = 1 - Math.min(minDistance / 5, 1); // –û–±—Ä–∞—Ç–Ω–∞—è —à–∫–∞–ª–∞, –±–ª–∏–∂–µ = –ª—É—á—à–µ
                        
                        const score = (normalizedRating * ratingWeight) + (normalizedDistance * distanceWeight);
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestIndex = i;
                        }
                    }
                    
                    if (bestIndex >= 0) {
                        selectedPoisIndices.push(bestIndex);
                    }
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ POI
                const selectedPois = selectedPoisIndices.map(index => filteredPois[index]);
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –º–∞—Ä—à—Ä—É—Ç–∞
                const pointsStr = selectedPois.map(poi => `${poi.latitude},${poi.longitude}`).join(';');
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
                const routeResponse = await fetch(`/api/thematic-route?points=${pointsStr}&profile=${profile}`);
                
                if (!routeResponse.ok) {
                    const errorText = await routeResponse.text();
                    throw new Error(`HTTP error! status: ${routeResponse.status}, message: ${errorText}`);
                }
                
                const data = await routeResponse.json();
                
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.remove();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                window.routeOptimized = true;
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
                displayRoute(data, selectedPois);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ –º–∞—Ä—à—Ä—É—Ç–∞, –µ—Å–ª–∏ —Ç–∞–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç –µ—Å—Ç—å
                const routeTypeElement = document.getElementById('route-type');
                if (routeTypeElement) {
                    routeTypeElement.textContent = '–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π';
                    routeTypeElement.style.color = '#4CAF50';
                    routeTypeElement.style.fontWeight = 'bold';
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Å–æ–±—ã–π —Å—Ç–∏–ª—å –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
                if (routeLayer) {
                    routeLayer.setStyle({
                        dashArray: null, // –°–ø–ª–æ—à–Ω–∞—è –ª–∏–Ω–∏—è –≤–º–µ—Å—Ç–æ –ø—É–Ω–∫—Ç–∏—Ä–Ω–æ–π
                        color: getRouteColor(profile)
                    });
                }
                
                console.log('–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                
            } catch (error) {
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.remove();
                
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                NeoDialog.alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞: ${error.message}`);
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–≤–µ—Ç –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ñ–∏–ª—è
        function getRouteColor(profile) {
            switch (profile) {
                case 'foot':
                    return '#3949AB'; // –ò–Ω–¥–∏–≥–æ –¥–ª—è –ø–µ—à–µ—Ö–æ–¥–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
                case 'bike':
                    return '#00897B'; // –ë–∏—Ä—é–∑–æ–≤—ã–π –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
                case 'car':
                    return '#E64A19'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
                default:
                    return '#3F51B5'; // –ò–Ω–¥–∏–≥–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞
        const optimizeRouteButton = document.getElementById('optimize-route-button');
        if (optimizeRouteButton) {
            optimizeRouteButton.addEventListener('click', buildOptimalThematicRoute);
            console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω');
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
        if (saveRouteButton) {
            saveRouteButton.addEventListener('click', function() {
                if (window.personalizationModule && routeLayer) {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞
                        const routeDistance = parseFloat(document.getElementById('info-distance').textContent);
                        const routeTime = parseInt(document.getElementById('info-time').textContent);
                        const routeProfile = currentProfile || 'foot';
                        
                        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                        const routePoints = routeLayer.getLatLngs();
                        if (!routePoints || routePoints.length === 0) {
                            console.error('–û—à–∏–±–∫–∞: –Ω–µ—Ç —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞');
                            NeoDialog.alert('–û—à–∏–±–∫–∞', '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—á–µ–∫');
                            return;
                        }
                        
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–æ—á–∫–∏ –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                        const formattedPoints = routePoints.map(latlng => [latlng.lat, latlng.lng]);
                        
                        // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∏ —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞
                    const currentRouteData = {
                            distance: routeDistance,
                            time: routeTime,
                            profile: routeProfile,
                            points: formattedPoints
                        };
                        
                        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ—á–∫–∞—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞
                        const currentPoisData = [];
                        
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã POI, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
                        if (poiMarkers && poiMarkers.length > 0) {
                            poiMarkers.forEach((marker, index) => {
                                const latLng = marker.getLatLng();
                                let name = `–¢–æ—á–∫–∞ ${index + 1}`;
                                let poiType = 'waypoint';
                                let rating = null;
                                
                                // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ø–∞–ø–∞ –º–∞—Ä–∫–µ—Ä–∞
                                if (marker._popup) {
                                    const popupContent = marker._popup._content;
                                    
                                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –∏–∑ —Ç–µ–≥–∞ <b>
                                    const nameMatch = popupContent.match(/<b>(.*?)<\/b>/);
                                    if (nameMatch && nameMatch[1]) {
                                        name = nameMatch[1];
                                    }
                                    
                                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–∏–ø POI
                                    const typeMatch = popupContent.match(/–¢–∏–ø: (.*?)(<br|$)/);
                                    if (typeMatch && typeMatch[1]) {
                                        poiType = typeMatch[1];
                                    }
                                    
                                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥
                                    const ratingMatch = popupContent.match(/–†–µ–π—Ç–∏–Ω–≥: (.*?)(<br|$)/);
                                    if (ratingMatch && ratingMatch[1]) {
                                        rating = parseFloat(ratingMatch[1]);
                                    }
                                }
                                
                                currentPoisData.push({
                                    lat: latLng.lat,
                                    lng: latLng.lng,
                                    name: name,
                                    type: poiType,
                                    rating: rating
                                });
                            });
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ—Ç –º–∞—Ä–∫–µ—Ä–æ–≤ POI, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                            if (routePoints.length > 0) {
                                const startPoint = routePoints[0];
                                currentPoisData.push({
                                    lat: startPoint.lat,
                                    lng: startPoint.lng,
                                    name: '–ù–∞—á–∞–ª–æ –º–∞—Ä—à—Ä—É—Ç–∞',
                                    type: 'waypoint'
                                });
                                
                                const endPoint = routePoints[routePoints.length - 1];
                                if (endPoint && endPoint !== startPoint) {
                                    currentPoisData.push({
                                        lat: endPoint.lat,
                                        lng: endPoint.lng,
                                        name: '–ö–æ–Ω–µ—Ü –º–∞—Ä—à—Ä—É—Ç–∞',
                                        type: 'waypoint'
                                    });
                                }
                            }
                        }
                        
                        console.log('–î–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', currentRouteData);
                        console.log('–î–∞–Ω–Ω—ã–µ POI –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', currentPoisData);
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ saveCurrentRoute, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise
                    window.personalizationModule.saveCurrentRoute(currentRouteData, currentPoisData)
                        .catch(error => {
                            if (error) {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                                NeoDialog.alert('–û—à–∏–±–∫–∞', `–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞: ${error.message}`);
                            }
                        });
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                        NeoDialog.alert('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞: ' + error.message);
                    }
                } else {
                    NeoDialog.alert('–í–Ω–∏–º–∞–Ω–∏–µ', '–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç');
                }
            });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        if (saveCulturalRouteButton) {
            saveCulturalRouteButton.addEventListener('click', function() {
                if (window.personalizationModule && window.culturalRouteLayer) {
                    try {
                        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Ä—à—Ä—É—Ç–µ
                        const distanceKm = document.getElementById('cultural-info-distance').textContent;
                        const timeMin = document.getElementById('cultural-info-time').textContent;
                        const routeProfile = getCurrentProfile();
                        
                        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                        const routePoints = window.culturalRouteLayer.getLatLngs();
                        if (!routePoints || routePoints.length === 0) {
                            console.error('–û—à–∏–±–∫–∞: –Ω–µ—Ç —Ç–æ—á–µ–∫ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞');
                            NeoDialog.alert('–û—à–∏–±–∫–∞', '–ö—É–ª—å—Ç—É—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—á–µ–∫');
                            return;
                        }
                        
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–æ—á–∫–∏ –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                        const formattedPoints = routePoints.map(latlng => [latlng.lat, latlng.lng]);
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞
                        const currentRouteData = {
                            distance: distanceKm,
                            time: timeMin,
                            profile: routeProfile,
                            points: formattedPoints
                        };
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞
                        const currentPoisData = [];
                        
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
                        if (window.culturalMarkers && window.culturalMarkers.length > 0) {
                            window.culturalMarkers.forEach((marker, index) => {
                                const latLng = marker.getLatLng();
                                
                                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–∞—Ä–∫–µ—Ä–∞
                                let poiData = {
                                    lat: latLng.lat,
                                    lng: latLng.lng,
                                    name: `–ö—É–ª—å—Ç—É—Ä–Ω–∞—è —Ç–æ—á–∫–∞ ${index + 1}`,
                                    type: 'cultural',
                                    rating: null
                                };
                                
                                // –ï—Å–ª–∏ —É –º–∞—Ä–∫–µ—Ä–∞ –µ—Å—Ç—å –ø–æ–ø–∞–ø, –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω–µ–≥–æ
                                if (marker._popup) {
                                    const popupContent = marker._popup._content;
                                    
                                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
                                    const nameMatch = popupContent.match(/<h3>(.*?)<\/h3>/);
                                    if (nameMatch && nameMatch[1]) {
                                        // –£–¥–∞–ª—è–µ–º –Ω–æ–º–µ—Ä –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                                        poiData.name = nameMatch[1].replace(/^\d+\.\s*/, '');
                                    }
                                    
                                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–∏–ø
                                    const typeMatch = popupContent.match(/–¢–∏–ø:<\/strong>\s*(.*?)<\//);
                                    if (typeMatch && typeMatch[1]) {
                                        poiData.type = typeMatch[1];
                                    }
                                    
                                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
                                    const ratingMatch = popupContent.match(/–†–µ–π—Ç–∏–Ω–≥:<\/strong>\s*(.*?)<\//);
                                    if (ratingMatch && ratingMatch[1] && ratingMatch[1] !== '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö') {
                                        poiData.rating = parseFloat(ratingMatch[1]);
                                    }
                                    
                                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–æ—Ç–æ URL, –µ—Å–ª–∏ –µ—Å—Ç—å
                                    const photoMatch = popupContent.match(/<img src="(.*?)"/);
                                    if (photoMatch && photoMatch[1]) {
                                        poiData.photoUrl = photoMatch[1];
                                    }
                                }
                                
                                currentPoisData.push(poiData);
                            });
                        }
                        
                        console.log('–î–∞–Ω–Ω—ã–µ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', currentRouteData);
                        console.log('–î–∞–Ω–Ω—ã–µ –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö POI –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', currentPoisData);
                        
                        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
                        window.personalizationModule.saveCurrentRoute(currentRouteData, currentPoisData)
                            .then(() => {
                                NeoDialog.alert('–£—Å–ø–µ—Ö', '–ö—É–ª—å—Ç—É—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                            })
                            .catch(error => {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                                NeoDialog.alert('–û—à–∏–±–∫–∞', `–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                            });
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                        NeoDialog.alert('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞: ' + error.message);
                    }
                } else {
                    NeoDialog.alert('–í–Ω–∏–º–∞–Ω–∏–µ', '–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –∫—É–ª—å—Ç—É—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç');
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ä—à—Ä—É—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –º–æ–¥—É–ª—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            if (window.personalizationModule) {
                setTimeout(() => {
                    window.personalizationModule.updateRouteParameters();
                }, 500); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ –∫–Ω–æ–ø–∫–∞–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
        document.getElementById('cultural-route-button').addEventListener('click', function() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ–¥ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ
            hideAllRouteInfo();
            
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
            if (typeof buildCulturalThematicRoute === 'function') {
                buildCulturalThematicRoute();
            } else {
                console.error('–§—É–Ω–∫—Ü–∏—è buildCulturalThematicRoute –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                NeoDialog.alert('–û—à–∏–±–∫–∞', '–§—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
        });

        // –ò–∑–º–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        thematicRouteButton.addEventListener('click', function() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—É–ª—å—Ç—É—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ–¥ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ
            hideAllRouteInfo();
            
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
            buildThematicRoute();
        });

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        window.hideAllRouteInfo = hideAllRouteInfo;
        window.showThematicRouteInfo = showThematicRouteInfo;
        window.showCulturalRouteInfo = showCulturalRouteInfo;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–∫–∏ –ø–æ –∫–∞—Ä—Ç–µ —á–µ—Ä–µ–∑ UI —ç–ª–µ–º–µ–Ω—Ç—ã
        function preventMapClicksThrough() {
            // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∫–ª–∏–∫–∏
            const uiElements = [
                document.getElementById('weather-panel'),
                document.getElementById('heatmap-panel'),
                document.getElementById('route-info'),
                document.getElementById('route-info-panel'),
                ...document.querySelectorAll('.neo-info-box, #route-description, #cultural-route-description')
            ].filter(el => el !== null);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            uiElements.forEach(element => {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                element.removeEventListener('click', stopPropagation);
                element.removeEventListener('dblclick', stopPropagation);
                element.removeEventListener('mousedown', stopPropagation);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                element.addEventListener('click', stopPropagation);
                element.addEventListener('dblclick', stopPropagation);
                element.addEventListener('mousedown', stopPropagation);
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ CSS pointer-events —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                element.style.pointerEvents = 'auto';
            });
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
            function stopPropagation(e) {
                e.stopPropagation();
            }
            
            console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–ª–∏–∫–æ–≤ —á–µ—Ä–µ–∑ UI –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è', uiElements.length, '—ç–ª–µ–º–µ–Ω—Ç–æ–≤');
        }
        
        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', preventMapClicksThrough);
        
        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–∫–∞–∑–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ
        const originalShowThematicRouteInfo = showThematicRouteInfo;
        window.showThematicRouteInfo = function() {
            originalShowThematicRouteInfo();
            setTimeout(preventMapClicksThrough, 100);
        };
        
        const originalShowCulturalRouteInfo = showCulturalRouteInfo;
        window.showCulturalRouteInfo = function() {
            originalShowCulturalRouteInfo();
            setTimeout(preventMapClicksThrough, 100);
        };
    </script>
</body>
</html>

